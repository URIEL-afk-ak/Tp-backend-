services:
  # Keycloak (Identity Provider) - EN PUERTO 8090
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
      KC_HTTP_ENABLED: "true"
      KC_DB: dev-file
      KC_HTTP_PORT: 8090
    ports:
      - "8090:8090"
    command: 
      - start-dev
      - --import-realm
    volumes:
      - ./realms/tpi-realm-realm.json:/opt/keycloak/data/import/tpi-realm-realm.json:ro
    networks:
      - backend-net
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8090/realms/master || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 20

  # API Gateway - CON VARIABLES DE ENTORNO PARA DOCKER
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      # âœ… CORREGIDO: usar los nombres reales de los contenedores
      KEYCLOAK_ISSUER_URI: http://keycloak:8090/realms/tpi-realm
      CLIENTES_URL: http://ms-clientes:8081
      CONTENEDORES_URL: http://ms-contenedores:8082
      DEPOSITOS_URL: http://ms-depositos:8083
      FACTURACION_URL: http://ms-facturacion:8084
      SOLICITUDES_URL: http://ms-solicitudes:8085
      RUTAS_TRAMOS_URL: http://ms-rutas-tramos:8086
      TRACKING_URL: http://ms-tracking:8087
      CAMIONES_URL: http://ms-camiones:8088
      # URLs para RutasService
      MICROSERVICE_CAMIONES_URL: http://ms-camiones:8088/api
      MICROSERVICE_CONTENEDORES_URL: http://ms-contenedores:8082/api
    networks:
      - backend-net

  # Microservicios - TODOS CON VARIABLE KEYCLOAK PARA DOCKER
  clientes:
    build:
      context: ./clientes/clientes
      dockerfile: Dockerfile
    container_name: ms-clientes
    ports:
      - "8081:8081"
    environment:
      KEYCLOAK_ISSUER_URI: http://keycloak:8090/realms/tpi-realm
    # depends_on:
      # keycloak:
        # condition: service_healthy
    networks:
      - backend-net

  contenedores:
    build:
      context: ./contenedores/contenedores
      dockerfile: Dockerfile
    container_name: ms-contenedores
    ports:
      - "8082:8082"
    environment:
      KEYCLOAK_ISSUER_URI: http://keycloak:8090/realms/tpi-realm
    # depends_on:
      # keycloak:
        # condition: service_healthy
    networks:
      - backend-net

  depositos:
    build:
      context: ./depositos/depositos
      dockerfile: Dockerfile
    container_name: ms-depositos
    ports:
      - "8083:8083"
    environment:
      KEYCLOAK_ISSUER_URI: http://keycloak:8090/realms/tpi-realm
    # depends_on:
      # keycloak:
        # condition: service_healthy
    networks:
      - backend-net

  facturacion:
    build:
      context: ./facturacion/facturacion
      dockerfile: Dockerfile
    container_name: ms-facturacion
    ports:
      - "8084:8084"
    environment:
      KEYCLOAK_ISSUER_URI: http://keycloak:8090/realms/tpi-realm
    # depends_on:
      # keycloak:
        # condition: service_healthy
    networks:
      - backend-net

  rutas_tramos:
    build:
      context: ./rutas_tramos/rutas_tramos
      dockerfile: Dockerfile
    container_name: ms-rutas-tramos
    ports:
      - "8086:8086"
    environment:
      KEYCLOAK_ISSUER_URI: http://keycloak:8090/realms/tpi-realm
    # depends_on:
      # keycloak:
        # condition: service_healthy
    networks:
      - backend-net

  solicitudes:
    build:
      context: ./solicitudes/solicitudes
      dockerfile: Dockerfile
    container_name: ms-solicitudes
    ports:
      - "8085:8085"
    environment:
      KEYCLOAK_ISSUER_URI: http://keycloak:8090/realms/tpi-realm
    # depends_on:
      # keycloak:
        # condition: service_healthy
    networks:
      - backend-net

  tracking:
    build:
      context: ./tracking/tracking
      dockerfile: Dockerfile
    container_name: ms-tracking
    ports:
      - "8087:8087"
    environment:
      KEYCLOAK_ISSUER_URI: http://keycloak:8090/realms/tpi-realm
    # depends_on:
      # keycloak:
        # condition: service_healthy
    networks:
      - backend-net

  camiones:
    build:
      context: ./camiones/camiones
      dockerfile: Dockerfile
    container_name: ms-camiones
    ports:
      - "8088:8088"
    environment:
      KEYCLOAK_ISSUER_URI: http://keycloak:8090/realms/tpi-realm
    # depends_on:
      # keycloak:
        # condition: service_healthy
    networks:
      - backend-net

networks:
  backend-net:
    driver: bridge